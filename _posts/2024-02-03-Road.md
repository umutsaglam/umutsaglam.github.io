---
title: Road
date: 2024-03-27 12:24:15
categories: [TryHackMe]
tags: [Easy]
image: /images/road.webp
---

Scriptin Genel Tanımı
Bu script, bir alan adının (domain) IP adresini bulur, bu IP adresi üzerinden subnet enumeration gerçekleştirir, SSL Transparency loglarını kontrol ederek subdomain keşfi yapar, DNS brute force saldırıları düzenler, belirli portları tarar ve e-posta adreslerini bulur. Bu işlemler, ağ güvenliği ve siber güvenlik analizi için kullanılan tekniklerdir.

Kütüphaneler ve Gereksinimler

````python
import socket
import requests
import pandas as pd
import requests, json
import numpy as np
import threading
from bs4 import BeautifulSoup
from colorama import Fore, Style
import queue
import dns.resolver
import dns.asyncresolver
from emailfinder.extractor import *
import concurrent.futures
import time
````

Bu kütüphaneler, IP adresi çözümleme, HTTP istekleri, veri analizi, HTML parse etme, renkli terminal çıktıları, DNS çözümleme, e-posta bulma ve çoklu iş parçacığı işlemleri için kullanılır.

Giriş Mesajı

````python
print(Style.BRIGHT + f"""{Fore.RED}
    Welcome to Attack Surface Discovery tool...
{Style.RESET_ALL}""")
Bu kod parçası, script çalıştığında kullanıcıya hoş geldiniz mesajı verir ve terminalde kırmızı renkte gösterir.

ip_bulma Fonksiyonu
python
Kodu kopyala
def ip_bulma(domain):
    ip = socket.gethostbyname(domain)
    print("*" * 30)
    print(f"{Fore.BLUE}IP Address: \n{Style.RESET_ALL}" + ip)
    return ip 
Bu fonksiyon, verilen domain için IP adresini bulur ve bu IP adresini ekrana yazdırır. socket.gethostbyname fonksiyonu kullanılarak domain'in IP adresi çözülür.

subnet_enumeration Fonksiyonu
````python
def subnet_enumeration(ip):
    print(f"{Fore.BLUE}[i] Enumerating subnet...{Style.RESET_ALL}")
    bgp = "https://bgp.he.net/ip/"
    url = bgp + ip
    response = requests.get(url)
    html = response.text
    soup = BeautifulSoup(html, 'html.parser')
    tbody = soup.select("#ipinfo > table > tbody")[0]
    trs = tbody.find_all("tr")

    asns = []
    subnets = []
    descriptions = []
    for tr in trs:
        tds = tr.find_all('td')

        asn = tds[0]
        subnet = tds[1].a
        description = tds[-1]

        asns.append(asn.text)
        subnets.append(subnet.text)
        descriptions.append(description.text)
    print(f"{Fore.GREEN}Subnets: {Style.RESET_ALL}")
    veri = {
        'ASN No' : asns,
        'Subnets' : subnets,
        'Descriptions' : descriptions
    }

    tablo = pd.DataFrame(veri)
    return tablo
````


Bu fonksiyon, IP adresine karşılık gelen subnet bilgilerini bulur. BGP (Border Gateway Protocol) ile ilgili verileri https://bgp.he.net/ip/ sitesinden çekerek, BeautifulSoup ile HTML içeriği parse edilir. ASN (Autonomous System Number), subnet ve açıklamaları bir tablo halinde döndürür.

subdomain_enumeration Fonksiyonu

````python
def subdomain_enumeration(domain):
    print(f"{Fore.BLUE}[i] Checking SSL Transparency logs for subdomain enumeration...{Style.RESET_ALL}")
    crt_sh = "https://crt.sh/?q=" +domain + "&output=json"
    subdomains = set()
    wildcardsubdomains = set()

    try:
        response = requests.get(crt_sh, timeout=25)
        if response.ok:
            content = response.content.decode('UTF-8')
            jsondata = json.loads(content)
            for i in range(len(jsondata)):
                name_value = jsondata[i]['name_value']
                if name_value.find('\n'):
                    subname_value = name_value.split('\n')
                    for subname_value in subname_value:
                        if subname_value.find('*'):
                            if subname_value not in subdomains:
                                subdomains.add(subname_value)
                        else:
                            if subname_value not in wildcardsubdomains:
                                wildcardsubdomains.add(subname_value)
    except:
        pass
    subdomain = subdomains.union(wildcardsubdomains)

    liste = list(subdomain)
    print(f"{Fore.GREEN}[+] SSL Transparency scanner finished. Detected subdomains:{Style.RESET_ALL}")
    print(f"{Fore.GREEN}-{Style.RESET_ALL}"*30)
    veri = {
        '' : liste,
    }

    tablo = pd.DataFrame(veri)
    return tablo
````

Bu fonksiyon, SSL Transparency loglarını kullanarak subdomain keşfi yapar. https://crt.sh sitesinden JSON formatında veri çekerek, subdomainleri bir set olarak toplar ve bir tablo halinde döndürür.

dns_sorgusu Fonksiyonu
````python
def dns_sorgusu(domain, wordlist, dns_server, global_dns_servers):
    for word in wordlist:
        word = word.strip()
        try: 
            subdomain = word + "." + domain
            resolver = dns.resolver.Resolver(configure=False)
            resolver.nameservers = [dns_server]
            answer = resolver.resolve(subdomain, 'A')
            print(subdomain)

            with dns_server_lock:
                global_dns_servers[dns_server] += 1
                if global_dns_servers[dns_server] == 5:
                    print(f"{Fore.RED}[i] Waiting for 5 seconds. DNS server: {dns_server} {Style.RESET_ALL}")
                    time.sleep(5)
                    global_dns_servers[dns_server] = 0
                    print(f"{Fore.YELLOW}[i] Thread lock finished! DNS server: {dns_server} {Style.RESET_ALL}")
        except Exception:
            continue
````

Bu fonksiyon, verilen domain için DNS brute force saldırısı yapar. wordlist içindeki her kelimeyi subdomain olarak ekleyerek DNS çözümlemesi yapılır. Her 5 sorgudan sonra DNS sunucusunu 5 saniye bekletir, bu da DNS sunucusunun bloklanmasını önlemeye yardımcı olur.

subdomain_enum_dns_brute Fonksiyonu

````python
def subdomain_enum_dns_brute(domain, global_dns_servers):
    print(f"{Fore.BLUE}[i] DNS Brute force started.{Style.RESET_ALL}")
    dosya = "wordlists_shuffled.txt"
    thread_count = 3 * len(global_dns_servers)
    threads = []

    with open(dosya, "r", encoding='utf-8') as dosya:
        wordlist = dosya.readlines()

    with concurrent.futures.ThreadPoolExecutor(max_workers=thread_count) as executor:
        for i, dns_server in enumerate(global_dns_servers):
            start = i * len(wordlist) // thread_count
            end = (i + 1) * len(wordlist) // thread_count
            thread_wordlist = wordlist[start:end]

            thread = executor.submit(dns_sorgusu, domain, thread_wordlist, dns_server, global_dns_servers)
            threads.append(thread)
    
    print(f"{Fore.BLUE}[i] Threads generated. Starting.{Style.RESET_ALL}")
    print(f"{Fore.GREEN}[+] DNS Brute Force results:{Style.RESET_ALL}")
    print(f"{Fore.GREEN}-{Style.RESET_ALL}" * 30)
    concurrent.futures.wait(threads)
    print(f"{Fore.BLUE}[i] DNS Brute force completed.{Style.RESET_ALL}")
````

Bu fonksiyon, DNS brute force saldırısını başlatır ve wordlist içindeki kelimeleri DNS çözümlemesi yaparak subdomain bulur. İş parçacıkları kullanılarak işlem hızlandırılır ve her DNS sunucusu için belirli sayıda iş parçacığı oluşturulur.

scan Fonksiyonu

````python
def scan(q, ip):
    global global_http_ports
    global global_open_http_ports
    global global_https_ports
    global global_open_https_ports

    while not q.empty():
        port = q.get()
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        try:
            result = sock.connect_ex((ip, port))
            if port in global_http_ports:
                if result == 0:
                    global_open_http_ports.append(int(port))
            elif port in global_https_ports:
                if result == 0:
                    global_open_https_ports.append(int(port))
            sock.close()
        except socket.error:
            print("Error")
        q.task_done()

````

Bu fonksiyon, verilen IP adresinde belirli portları tarar ve açık olanları listeye ekler. İş parçacıkları kullanılarak paralel port tarama yapılır ve sonuçlar global_open_http_ports ve global_open_https_ports listelerine eklenir.

port_scan Fonksiyonu

````python
def port_scan(ip):
    print(f"{Fore.BLUE}[i] Scanning ports...{Style.RESET_ALL}")
    http_q = queue.Queue()
    https_q = queue.Queue()

    for i in global_http_ports:
        http_q.put(i)
    for i in global_https_ports:
        https_q.put(i)

    threads = []
    for i in range(len(global_http_ports)):
        worker = threading.Thread(target=scan, args=(http_q, ip))
        worker.start()
        threads.append(worker)

    for i in range(len(global_https_ports)):
        worker = threading.Thread(target=scan, args=(https_q, ip))
        worker.start()
        threads.append(worker)

    for thread in threads:
        thread.join()

    print(f"{Fore.GREEN}[+] Open HTTP/HTTPS Ports: {Style.RESET_ALL}")
    veri = {
        'HTTP Ports' : global_open_http_ports
    }

    tablo = pd.DataFrame(veri)
    veri2 = {
        'HTTPS Ports' : global_open_https_ports
    }

    tablo2 = pd.DataFrame(veri2)
    return tablo, tablo2
````

Bu fonksiyon, IP adresi üzerinde port taraması yapar. HTTP ve HTTPS portlarını taramak için iki ayrı iş kuyruğu oluşturur ve iş parçacıklarıyla bu portları tarar. Açık olan portlar, pandas DataFrame formatında döndürülür.

mail_bulma Fonksiyonu
````
def mail_bulma(domain):
    print(f"{Fore.BLUE}[i] Scanning email addresses...{Style.RESET_ALL}")
    emails1 = get_emails_from_google(domain)
    emails2 = get_emails_from_bing(domain)
    emails3 = get_emails_from_baidu(domain)
    emails = emails1 + emails2 +  emails3
    return emails
````

Bu fonksiyon, verilen domain için e-posta adreslerini bulur. Google, Bing ve Baidu arama motorlarından e-posta adreslerini toplar ve birleştirir.


main Fonksiyonu

````python
def main():
    print(f"{Fore.GREEN}Enter Domain: {Style.RESET_ALL}")
    domain = input()
    ip = ip_bulma(domain)
    print("*" * 30)

    print(subnet_enumeration(ip))
    print("*" * 30)

    print(subdomain_enumeration(domain))
    print("*" * 30)

    http_ports, https_ports = port_scan(ip)
    merged_ports = pd.concat([http_ports, https_ports], axis=1)
    cleaned_df = merged_ports.replace([np.nan, -np.inf], "")
    print(cleaned_df)
    print("*" * 30)
    emails = mail_bulma(domain)
    print(f"{Fore.GREEN}[+] Detected email addresses:{Style.RESET_ALL}")
    print(f"{Fore.GREEN}-{Style.RESET_ALL}" * 30)
    for email in emails:
        print(email)
    print("*" * 30)
    subdomain_enum_dns_brute(domain, global_dns_servers)
````
Bu fonksiyon, scriptin ana fonksiyonudur ve kullanıcıdan domain alarak diğer fonksiyonları sırasıyla çağırır. IP bulma, subnet enumeration, subdomain enumeration, port taraması, e-posta bulma ve DNS brute force işlemlerini gerçekleştirir.

Global Değişkenler ve __main__ Bloğu

````python

global_http_ports = [80, 81, 82,  554,  591, 4791, 5554,  5060,  5800, 5900, 6638,  8008,  8080, 8081, 8181, 8090, 8554]
global_open_http_ports = []
global_https_ports = [443, 8443]
global_open_https_ports = []
global_dns_servers = {}
dns_server_lock = threading.Lock()

if __name__ == "__main__":
    with open("dns_servers.txt", "r", encoding='utf-8') as dosya:
        dnslist = dosya.readlines()
    for dns_elem in dnslist:
        clear_dns = dns_elem.strip()
        global_dns_servers[clear_dns] = 0
        
    main()
````
Bu bölümde, global değişkenler tanımlanır ve DNS sunucuları dns_servers.txt dosyasından okunur. Ana fonksiyon çağrılır.

Özet
Bu script, bir alan adının saldırı yüzeyini keşfetmek için çeşitli ağ ve güvenlik analiz araçlarını kullanır. IP bulma, subnet enumeration, subdomain enumeration, DNS brute force, port taraması ve e-posta bulma işlemleri gerçekleştirilir. İşlemler paralel olarak gerçekleştirilir ve sonuçlar kullanıcıya pandas DataFrame formatında sunulur.
